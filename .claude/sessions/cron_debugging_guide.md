# Gu√≠a de Debugging: Cron Token Refresh

**Problema**: El cron job responde con √©xito pero no actualiza `token_update_count` ni `last_token_update_date`

**Fecha**: 2025-10-20

---

## üö® Problema Identificado

### S√≠ntoma
```bash
POST https://aim-harder-webbot.vercel.app/api/cron/refresh-tokens

Response:
{
  "success": true,
  "message": "Token refresh job started in background",
  "timestamp": "2025-10-20T07:04:47.275Z"
}
```

**Pero** en la base de datos:
- `token_update_count` NO se incrementa
- `last_token_update_date` sigue siendo `null`

### Causa Ra√≠z

El endpoint `/api/cron/refresh-tokens` ejecuta el proceso en **background** (as√≠ncrono):

```typescript
// app/api/cron/refresh-tokens/route.ts:19-32
processTokenRefreshInBackground().catch((error) => {
  console.error("Background token refresh error:", error);
});

// Respond immediately (BEFORE processing completes)
return NextResponse.json({
  success: true,
  message: "Token refresh job started in background",
  timestamp: new Date().toISOString(),
}, { status: 202 }); // 202 Accepted
```

**Esto significa**:
- El endpoint responde inmediatamente con 202 Accepted
- El proceso real se ejecuta en background
- **Los logs del proceso real NO son visibles en la respuesta HTTP**
- Necesitamos ver los logs de Vercel para saber qu√© pas√≥

---

## üõ†Ô∏è Endpoints de Debugging Creados

### 1. GET `/api/debug/cron-logs`

**Prop√≥sito**: Ver el estado actual de todas las sesiones

**Uso**:
```bash
GET https://aim-harder-webbot.vercel.app/api/debug/cron-logs
```

**Response**:
```json
{
  "success": true,
  "timestamp": "2025-10-20T10:30:00Z",
  "totalSessions": 3,
  "sessions": [
    {
      "email": "user@example.com",
      "fingerprint": "dev-abc123...",
      "sessionType": "device",
      "hasToken": true,
      "tokenLength": 156,
      "cookieCount": 8,
      "createdAt": "2025-10-20T08:00:00Z",
      "updatedAt": "2025-10-20T10:00:00Z",
      "lastTokenUpdateDate": "2025-10-20T10:00:00Z",  // ‚Üê Verificar esto
      "tokenUpdateCount": 5,  // ‚Üê Verificar esto
      "lastTokenUpdateError": null,
      "minutesSinceUpdate": 30
    },
    // ... m√°s sesiones
  ],
  "stats": {
    "totalSessions": 3,
    "deviceSessions": 2,
    "backgroundSessions": 1,
    "sessionsWithTokenUpdates": 2,  // ‚Üê ¬øCu√°ntas tienen updates?
    "sessionsWithErrors": 0
  }
}
```

**Qu√© verificar**:
1. ¬øCu√°ntas sesiones existen?
2. ¬øTienen `tokenUpdateCount > 0`?
3. ¬ø`lastTokenUpdateDate` es `null` o tiene fecha?
4. ¬ø`minutesSinceUpdate` es > 20? (necesita refresh)

---

### 2. POST `/api/debug/test-token-refresh`

**Prop√≥sito**: Ejecutar token refresh **S√çNCRONO** para un usuario espec√≠fico y ver TODOS los logs

**Uso**:
```bash
POST https://aim-harder-webbot.vercel.app/api/debug/test-token-refresh
Content-Type: application/json

{
  "email": "tu-email@example.com"
}
```

**Response**:
```json
{
  "success": true,
  "email": "user@example.com",
  "timestamp": "2025-10-20T10:30:00Z",
  "totalSessions": 2,
  "results": [
    {
      "sessionId": "user@example.com_device_abc123",
      "sessionType": "device",
      "fingerprint": "dev-abc123...",
      "status": "success",  // ‚Üê "success", "failed", "expired", "skipped"
      "newTokenLength": 156,
      "aimharderResponse": {
        "success": true,
        "logout": false,
        "hasNewToken": true,
        "newTokenLength": 156,
        "cookieCount": 8,
        "error": null
      }
    },
    // ... m√°s sesiones
  ],
  "verification": [
    {
      "sessionType": "device",
      "fingerprint": "dev-abc123...",
      "tokenUpdateCount": 6,  // ‚Üê ¬øSe increment√≥?
      "lastTokenUpdateDate": "2025-10-20T10:30:00Z",  // ‚Üê ¬øSe actualiz√≥?
      "lastTokenUpdateError": null
    }
  ],
  "logs": [
    "2025-10-20T10:30:00.000Z - [TEST] Starting token refresh test for user@example.com",
    "2025-10-20T10:30:00.100Z - [TEST] Step 1: Fetching sessions for user@example.com",
    "2025-10-20T10:30:00.200Z - [TEST] Found 2 sessions for user@example.com",
    // ... TODOS los logs paso a paso
  ]
}
```

**Ventajas**:
- ‚úÖ Ejecuci√≥n **S√çNCRONA** (espera a que termine)
- ‚úÖ TODOS los logs incluidos en la respuesta
- ‚úÖ Verificaci√≥n autom√°tica despu√©s del update
- ‚úÖ Paso a paso con timestamps

---

## üìã Plan de Debugging

### Paso 1: Ver Estado Actual

```bash
GET https://aim-harder-webbot.vercel.app/api/debug/cron-logs
```

**Qu√© buscar**:
- ¬øExisten sesiones?
- ¬øQu√© valores tienen `tokenUpdateCount` y `lastTokenUpdateDate`?
- ¬øHay errores en `lastTokenUpdateError`?

---

### Paso 2: Ejecutar Test S√≠ncrono

```bash
POST https://aim-harder-webbot.vercel.app/api/debug/test-token-refresh
Content-Type: application/json

{
  "email": "TU_EMAIL_AQUI"
}
```

**Qu√© buscar en la respuesta**:

1. **results[]** - ¬øQu√© pas√≥ con cada sesi√≥n?
   - `status: "success"` ‚Üí OK
   - `status: "failed"` ‚Üí Ver `error` field
   - `status: "expired"` ‚Üí Session expirada
   - `status: "skipped"` ‚Üí Token muy reciente

2. **aimharderResponse** - ¬øQu√© respondi√≥ AimHarder?
   - `success: true` ‚Üí AimHarder respondi√≥ OK
   - `logout: true` ‚Üí Token expirado
   - `hasNewToken: true` ‚Üí Recibi√≥ nuevo token
   - `error` ‚Üí Mensaje de error

3. **verification[]** - ¬øSe actualiz√≥ la DB?
   - `tokenUpdateCount` ‚Üí ¬øSe increment√≥?
   - `lastTokenUpdateDate` ‚Üí ¬øTiene fecha nueva?

4. **logs[]** - Logs paso a paso
   - Lee los logs cronol√≥gicamente
   - Identifica d√≥nde falla

---

### Paso 3: Analizar Logs

**Buscar en los logs**:

```
"[TEST] ‚úÖ Token refresh successful, updating database..."
"[TEST] Updating token in database..."
"[TEST] ‚úÖ Token updated"
"[TEST] Updating token update metadata..."
"[TEST] ‚úÖ Metadata updated"
```

**Si ves estos logs ‚Üí La actualizaci√≥n se ejecut√≥ correctamente**

**Si NO ves estos logs ‚Üí Hay un error antes**

Buscar mensajes de error:
```
"[TEST] ‚ùå Token refresh failed: ..."
"[TEST] ‚ùå Session expired (logout: 1)"
"[TEST] ‚ùå Error processing session ..."
```

---

## üîç Posibles Problemas y Soluciones

### Problema 1: AimHarder responde con `logout: true`

**S√≠ntoma**:
```json
{
  "aimharderResponse": {
    "logout": true
  }
}
```

**Causa**: El token ya expir√≥ (> 30 min sin refresh)

**Soluci√≥n**:
- Usuario debe hacer re-login
- Se crear√°n nuevas sesiones

---

### Problema 2: AimHarder responde con error

**S√≠ntoma**:
```json
{
  "aimharderResponse": {
    "success": false,
    "error": "Invalid token format"
  }
}
```

**Causa**: Token corrupto o cookies inv√°lidas

**Soluci√≥n**:
- Revisar formato del token en DB
- Verificar cookies en DB
- Usuario debe hacer re-login

---

### Problema 3: DB update falla

**S√≠ntoma en logs**:
```
"[TEST] Updating token update metadata..."
(no hay "[TEST] ‚úÖ Metadata updated")
```

**Posible causa**: Error en Supabase query

**Debugging adicional**:
1. Revisar logs de Vercel (pueden tener stack trace)
2. Verificar permisos de Supabase
3. Verificar que `fingerprint` exista en DB

---

### Problema 4: Session not found

**S√≠ntoma**:
```json
{
  "success": false,
  "error": "No sessions found for user@example.com"
}
```

**Causa**: No hay sesiones en DB para ese email

**Soluci√≥n**:
- Usuario debe hacer login primero
- Verificar que dual login cre√≥ ambas sesiones (device + background)

---

## üìä An√°lisis del C√≥digo Actual

### ¬øPor qu√© el cron NO muestra logs?

**Problema**: El cron ejecuta en background y retorna inmediatamente

```typescript
// app/api/cron/refresh-tokens/route.ts

// Ejecuta en background (no espera)
processTokenRefreshInBackground().catch(...);

// Retorna INMEDIATAMENTE (antes de que termine el proceso)
return NextResponse.json({ success: true, ... });
```

**Consecuencia**:
- Los logs de `processTokenRefreshInBackground()` van a **Vercel logs** (no HTTP response)
- Solo podemos ver los logs en Vercel Dashboard ‚Üí Functions ‚Üí Logs
- La respuesta HTTP solo dice "started in background"

**Alternativa para debugging**:
- Usar `/api/debug/test-token-refresh` (s√≠ncrono, logs en response)

---

### ¬øD√≥nde se actualizan los campos?

**`token_update_count` y `last_token_update_date`**:

```typescript
// modules/auth/api/services/supabase-session.service.ts:626-679

static async updateTokenUpdateData(
  email: string,
  success: boolean,
  error?: string,
  fingerprint?: string
): Promise<void> {
  if (success) {
    // Incrementa el contador
    const updateData = {
      token_update_count: currentCount + 1,  // ‚Üê Aqu√≠
      last_token_update_date: now,           // ‚Üê Aqu√≠
      last_token_update_error: null,
      updated_at: now,
    };

    // Update query con fingerprint
    await supabaseAdmin
      .from("auth_sessions")
      .update(updateData)
      .eq("user_email", email)
      .eq("fingerprint", fingerprint);  // ‚Üê Debe coincidir
  }
}
```

**Llamado desde cron**:

```typescript
// app/api/cron/refresh-tokens/route.ts:199-204

await SupabaseSessionService.updateTokenUpdateData(
  session.email,
  true,  // success
  undefined,
  session.fingerprint  // ‚Üê CR√çTICO: debe ser el correcto
);
```

**Posible fallo**:
- Si `session.fingerprint` es `null` o vac√≠o ‚Üí Query no encuentra la sesi√≥n
- Si `session.email` no coincide ‚Üí Query no encuentra la sesi√≥n

---

## üéØ Siguientes Pasos

### 1. Ejecutar Debug Endpoints

```bash
# Ver estado actual
curl https://aim-harder-webbot.vercel.app/api/debug/cron-logs

# Test s√≠ncrono para tu usuario
curl -X POST https://aim-harder-webbot.vercel.app/api/debug/test-token-refresh \
  -H "Content-Type: application/json" \
  -d '{"email":"TU_EMAIL"}'
```

### 2. Analizar Respuestas

- Revisar `verification[]` para ver si `tokenUpdateCount` se increment√≥
- Revisar `logs[]` para ver paso a paso qu√© pas√≥
- Buscar mensajes de error

### 3. Revisar Vercel Logs

Si el test s√≠ncrono funciona pero el cron no:

1. Ir a Vercel Dashboard
2. Tu proyecto ‚Üí Functions ‚Üí Logs
3. Filtrar por `/api/cron/refresh-tokens`
4. Buscar logs con `[CRON_REFRESH xxx]`
5. Identificar errores

### 4. Reportar Hallazgos

Una vez ejecutes los endpoints, comparte:
- Response de `/api/debug/cron-logs`
- Response de `/api/debug/test-token-refresh`
- Logs de Vercel (si es posible)

---

## üìù Checklist de Verificaci√≥n

Antes de ejecutar:
- [ ] Deploy los nuevos endpoints de debug
- [ ] Tienes acceso a Vercel Dashboard
- [ ] Sabes tu email de usuario
- [ ] Tienes sesiones activas en DB (hiciste login)

Despu√©s de ejecutar `/api/debug/cron-logs`:
- [ ] ¬øCu√°ntas sesiones existen?
- [ ] ¬ø`tokenUpdateCount` es > 0?
- [ ] ¬ø`lastTokenUpdateDate` tiene valor?
- [ ] ¬ø`minutesSinceUpdate` es > 20?

Despu√©s de ejecutar `/api/debug/test-token-refresh`:
- [ ] ¬øTodas las sesiones tienen `status: "success"`?
- [ ] ¬ø`aimharderResponse.success` es `true`?
- [ ] ¬ø`verification[].tokenUpdateCount` se increment√≥?
- [ ] ¬ø`verification[].lastTokenUpdateDate` se actualiz√≥?
- [ ] ¬øLos logs muestran "‚úÖ Metadata updated"?

---

**√öltima Actualizaci√≥n**: 2025-10-20
**Estado**: Endpoints de debugging creados, esperando ejecuci√≥n de tests
